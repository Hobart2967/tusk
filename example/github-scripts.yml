---
tasks:
  bootstrap:
    run:
      - when:
          exists: Brewfile
          os: darwin
        command: brew bundle

      - when:
          exists: .ruby-version
          test: -z "$(rbenv version-name 2>/dev/null)"
        run:
          - rbenv install --skip-existing
          - which bundle >/dev/null 2>&1 || { gem install bundler; rbenv rehash }

      - when:
          exists: ./Gemfile
        run: bundle check --path vendor/gems >/dev/null 2>&1 || bundle install --path vendor/gems --quiet --without production

  console:
    options:
      env:
        default: local
        type: string
    directory: ${tusk_root}
    script:
      - when:
          test: ${env} = production
        run: heroku run rails console --app heroku-app-name-staging
      - when:
          test: ${env} = staging
        run: heroku run rails console --app heroku-app-name-staging
      - when:
          test: ${env} = local
        run:
          - script/update
          - bin/rails console

  test:
    run:
      - task: bootstrap
      - command: commandbin/rake db:create db:reset
      - when:
          test:
            - -z "$RAILS_ENV"
            - -z "$RACK_ENV"
        command:
          # Only things for a development environment will run here
          - true
